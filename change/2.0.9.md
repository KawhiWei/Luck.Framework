# change 2.0.9 version

## Breaking Changes
### 1、RabbitMQ EventBus 完全重构

+ **API 变更**: `AddEventBusRabbitMq` 重命名为 `AddLuckEventBusRabbitMq`
  ```csharp
  // 旧版本
  services.AddEventBusRabbitMq(config => { ... });
  
  // 新版本
  services.AddLuckEventBusRabbitMq(config => { ... });
  ```

+ **完全异步架构**: 移除所有同步方法，仅支持异步 API
  ```csharp
  // 仅支持异步方法
  Task PublishAsync<TEvent>(TEvent @event, ...)
  Task SubscribeAsync(...)
  ```

+ **发布/消费通道隔离**: 独立的通道池避免相互影响
  - `GetPublishChannelAsync()` - 发布专用通道
  - `GetConsumerChannelAsync()` - 消费专用通道

## Add
### 1、新增 Luck.EventBus.OpenTelemetry 包

+ 支持分布式链路追踪
+ 自动订阅诊断事件并转换为 OpenTelemetry Activities
+ 支持 OTLP/gRPC 导出到 OpenObserve、Jaeger 等后端

```csharp
services.AddOpenTelemetry()
    .WithTracing(tracing =>
    {
        tracing.AddLuckEventBusInstrumentation()
               .AddOtlpExporter(options =>
               {
                   options.Endpoint = new Uri("http://localhost:5081");
                   options.Protocol = OtlpExportProtocol.Grpc;
               });
    });
```

### 2、Luck.Framework - 新增事件模型

+ `LuckEventData` - 事件数据基类，包含 `RawContent` 原始消息内容
+ `PublishEventData` - 发布事件数据
+ `ConsumeEventData` - 消费事件数据
+ `ProcessEventData` - 处理事件数据
+ `EventIds` - 事件 ID 常量
+ `EventBusType` - 事件总线类型枚举（RabbitMQ/Kafka）
+ `DiagnosticConstants` - 诊断常量

### 3、诊断事件系统

+ 完整的事件发布、接收、处理链路追踪
+ 所有事件包含 `RawContent` 属性记录原始 JSON 消息
+ 诊断监听器名称: `Luck.EventBus.Diagnostics`

## Update
### 1、RabbitMQ.Client 升级

+ RabbitMQ.Client: 6.8.1 → 7.2.0
+ 支持完全异步 API (CreateConnectionAsync, CreateChannelAsync, BasicPublishAsync, BasicConsumeAsync)
+ 使用 `DeliveryModes.Persistent` 替代 `DeliveryMode = 2`

### 2、IRabbitMqPersistentConnection 接口更新

+ 移除同步方法：`TryConnect()`, `GetChannel()`, `CreateModel()`
+ 新增异步方法：
  - `TryConnectAsync()`
  - `GetPublishChannelAsync()`
  - `GetConsumerChannelAsync()`
  - `CreateChannelAsync()`

### 3、IIntegrationEventBus 接口更新

+ `Publish()` → `PublishAsync()`
+ `Subscribe()` → `SubscribeAsync()`

## Documentation
### 1、新增/更新文档

+ `Luck.EventBus.RabbitMQ/README.md` - 完整使用文档
+ `Luck.EventBus.OpenTelemetry/README.md` - OpenTelemetry 集成文档
+ 删除过时的 `Diagnostics/USAGE.md`

## Bug Fixes
### 1、修复诊断事件订阅

+ 修复 `IsEnabled` 检查导致事件丢失的问题
+ 使用 `DiagnosticListener.AllListeners` 正确订阅事件
